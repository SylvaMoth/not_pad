<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 24px 32px 24px 32px;
      font-family: 'Segoe UI', sans-serif;
      line-height: 1.7;
    }
    body.dark {
      background: #1e1e1e;
      color: #d4d4d4;
    }
    body.light {
      background: #ffffff;
      color: #000000;
    }
    .search-bar {
      position: fixed;
      top: 8px;
      right: 8px;
      padding: 8px 12px;
      display: none;
      align-items: center;
      gap: 6px;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    body.dark .search-bar {
      background: #2d2d2d;
      border: 1px solid #3e3e3e;
    }
    body.light .search-bar {
      background: #f0f0f0;
      border: 1px solid #d0d0d0;
    }
    .search-bar.active {
      display: flex;
    }
    .search-bar input {
      padding: 4px 8px;
      font-size: 13px;
      width: 200px;
      border-radius: 0;
    }
    body.dark .search-bar input {
      border: 1px solid #3e3e3e;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    body.light .search-bar input {
      border: 1px solid #ababab;
      background: #ffffff;
      color: #000000;
    }
    .search-bar button {
      padding: 4px 10px;
      cursor: pointer;
      font-size: 12px;
      border-radius: 0;
    }
    body.dark .search-bar button {
      border: 1px solid #3e3e3e;
      background: #2d2d2d;
      color: #d4d4d4;
    }
    body.light .search-bar button {
      border: 1px solid #ababab;
      background: #ffffff;
      color: #000000;
    }
    .search-bar button:hover {
      filter: brightness(1.1);
    }
    .search-count {
      font-size: 12px;
      color: #888;
      min-width: 50px;
    }
    mark {
      background: #ac5e22;
      color: #ffffff;
      padding: 0 2px;
    }
    mark.current {
      background: #ff8c00;
    }
    h1 {
      font-size: 32px;
      font-weight: 700;
      margin: 24px 0 16px 0;
    }
    h2 {
      font-size: 26px;
      font-weight: 600;
      margin: 20px 0 12px 0;
    }
    h3 {
      font-size: 20px;
      font-weight: 600;
      margin: 16px 0 10px 0;
    }
    p {
      margin: 12px 0;
    }
    ul, ol {
      margin: 12px 0;
      padding-left: 32px;
    }
    li {
      margin: 6px 0;
    }
    code {
      padding: 2px 6px;
      border-radius: 0;
      font-family: 'Consolas', monospace;
      font-size: 13px;
    }
    body.dark code {
      background: #2d2d2d;
    }
    body.light code {
      background: #f5f5f5;
    }
    pre {
      padding: 16px;
      border-radius: 0;
      overflow-x: auto;
      margin: 16px 0;
      font-family: 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.5;
    }
    body.dark pre {
      background: #2d2d2d;
    }
    body.light pre {
      background: #f5f5f5;
    }
    pre code {
      background: none;
      padding: 0;
    }
    blockquote {
      padding-left: 16px;
      margin: 16px 0;
      opacity: 0.8;
    }
    body.dark blockquote {
      border-left: 4px solid #555555;
    }
    body.light blockquote {
      border-left: 4px solid #cccccc;
    }
  </style>
</head>
<body>
<div class="search-bar" id="searchBar">
  <input type="text" id="searchInput" placeholder="Find...">
  <button id="btnPrev">↑</button>
  <button id="btnNext">↓</button>
  <span class="search-count" id="searchCount"></span>
  <button id="btnClose">✕</button>
</div>
<div id="content"></div>
<script>
const { ipcRenderer } = require('electron');

const searchBar = document.getElementById('searchBar');
const searchInput = document.getElementById('searchInput');
const searchCount = document.getElementById('searchCount');
const btnPrev = document.getElementById('btnPrev');
const btnNext = document.getElementById('btnNext');
const btnClose = document.getElementById('btnClose');
const contentDiv = document.getElementById('content');

let matches = [];
let currentIndex = -1;
let originalHTML = '';

// Receive content and theme from main process
ipcRenderer.on('preview-content', (event, html, theme) => {
  console.log('Received preview content');
  console.log('HTML length:', html ? html.length : 0);
  console.log('Theme:', theme);
  contentDiv.innerHTML = html;
  originalHTML = html;
  document.body.className = theme;
  console.log('Content set successfully');
});

document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.key === 'f') {
    e.preventDefault();
    searchBar.classList.add('active');
    searchInput.focus();
    searchInput.select();
  }
  if (e.key === 'Escape') {
    closeSearch();
  }
});

function closeSearch() {
  searchBar.classList.remove('active');
  contentDiv.innerHTML = originalHTML;
  matches = [];
  currentIndex = -1;
}

function escapeRegex(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function performSearch() {
  const query = searchInput.value;
  contentDiv.innerHTML = originalHTML;
  matches = [];
  currentIndex = -1;
  
  if (!query) {
    searchCount.textContent = '';
    return;
  }
  
  const escapedQuery = escapeRegex(query);
  const regex = new RegExp('(' + escapedQuery + ')', 'gi');
  const walker = document.createTreeWalker(contentDiv, NodeFilter.SHOW_TEXT, null, false);
  const nodesToReplace = [];
  
  while (walker.nextNode()) {
    const node = walker.currentNode;
    if (regex.test(node.textContent)) {
      nodesToReplace.push(node);
    }
  }
  
  let matchCount = 0;
  nodesToReplace.forEach(node => {
    const fragment = document.createDocumentFragment();
    const parts = node.textContent.split(regex);
    
    parts.forEach(part => {
      if (regex.test(part)) {
        const mark = document.createElement('mark');
        mark.textContent = part;
        mark.setAttribute('data-match', matchCount);
        fragment.appendChild(mark);
        matches.push(mark);
        matchCount++;
      } else {
        fragment.appendChild(document.createTextNode(part));
      }
    });
    
    node.parentNode.replaceChild(fragment, node);
  });
  
  if (matches.length > 0) {
    currentIndex = 0;
    highlightCurrent();
    searchCount.textContent = `${currentIndex + 1}/${matches.length}`;
  } else {
    searchCount.textContent = 'No matches';
  }
}

function highlightCurrent() {
  matches.forEach((m, i) => {
    m.classList.toggle('current', i === currentIndex);
  });
  if (matches[currentIndex]) {
    matches[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

function nextMatch() {
  if (matches.length === 0) return;
  currentIndex = (currentIndex + 1) % matches.length;
  highlightCurrent();
  searchCount.textContent = `${currentIndex + 1}/${matches.length}`;
}

function prevMatch() {
  if (matches.length === 0) return;
  currentIndex = currentIndex - 1;
  if (currentIndex < 0) currentIndex = matches.length - 1;
  highlightCurrent();
  searchCount.textContent = `${currentIndex + 1}/${matches.length}`;
}

searchInput.addEventListener('input', performSearch);
searchInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    if (e.shiftKey) {
      prevMatch();
    } else {
      nextMatch();
    }
  }
});

btnPrev.addEventListener('click', prevMatch);
btnNext.addEventListener('click', nextMatch);
btnClose.addEventListener('click', closeSearch);
</script>
</body>
</html>
